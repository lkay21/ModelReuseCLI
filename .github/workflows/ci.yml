name: Code Quality Check + Full Build

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ---------- Python Setup ----------
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # ---------- Node.js Setup ----------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ---------- Environment Variables ----------
      - name: Set up environment variables
        run: |
          echo "LOG_LEVEL=0" >> .env
          echo "LOG_FILE=log.log" >> .env
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GEN_AI_STUDIO_API_KEY: ${{ secrets.GEN_AI_STUDIO_API_KEY }}
          LOG_LEVEL: 0
          LOG_FILE: log.log

      # ---------- Install Dependencies ----------
      - name: Install dependencies
        run: ./run install

      # ---------- flake8 Linting ----------
      - name: Run flake8 checks
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exit-zero
          flake8 . --count --max-complexity=10 --max-line-length=128 --statistics --exit-zero

      # ---------- Run Tests ----------
      - name: Run tests
        run: python3 -m coverage run -m pytest tests/ -v
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GEN_AI_STUDIO_API_KEY: ${{ secrets.GEN_AI_STUDIO_API_KEY }}
          LOG_LEVEL: 0
          LOG_FILE: log.log
      
      - name: Generate coverage report
        run: |
          coverage_percent=$(python3 -m coverage report | tail -1 | awk '{print $NF}' | sed 's/%//')
          passed=$(grep -o "[0-9]\+ passed" pytest.log 2>/dev/null | cut -d' ' -f1 || echo "0")
          echo "Tests completed with ${coverage_percent}% coverage"
      